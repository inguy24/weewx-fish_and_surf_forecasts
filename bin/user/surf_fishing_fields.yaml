# WeeWX Surf & Fishing Forecast Extension Configuration
# Phase II: Local Surf & Fishing Forecast System
# Reorganized by data source for logical structure
#
# This file is read by install.py during installation to configure
# the extension. The service reads configuration from weewx.conf only.

# =============================================================================
# NOAA GFS WAVE DATA SOURCE - All GFS Wave configuration together
# =============================================================================
noaa_gfs_wave:
  description: "NOAA GFS-Wave Model (WaveWatch III coupled with GFS)"
  base_url: "https://nomads.ncep.noaa.gov/pub/data/nccf/com/gfs/prod/"
  url_pattern: "gfs.{yyyymmdd}/{hh}/wave/gridded/"
  file_pattern: "gfswave.t{hh}z.{grid_name}.f{fff}.grib2"
  documentation: "https://polar.ncep.noaa.gov/waves/Model_Description.pdf"
  
  # Grid definitions with selection logic combined
  grids:
    us_east_coast:
      description: "US East Coast & Gulf (16km resolution)"
      grid_name: "atlocn.0p16"
      bounds: [0, 55, -100, -50]  # lat_min, lat_max, lon_min, lon_max
      resolution: 0.16
      priority: 1
      geographic_selection:
        regions: ["us_east_coast", "us_gulf_coast"]
        bounds: [24.0, 50.0, -100.0, -65.0]
        backup_grid: "global.0p16"
        
    us_west_coast:
      description: "US West Coast (16km resolution)" 
      grid_name: "wcoast.0p16"
      bounds: [25, 50, -150, -110]
      resolution: 0.16
      priority: 1
      geographic_selection:
        regions: ["us_west_coast"]
        bounds: [24.0, 50.0, -130.0, -95.0]
        backup_grid: "global.0p16"
        
    hawaii_pacific:
      description: "Hawaii & Eastern Pacific (16km resolution)"
      grid_name: "epacif.0p16"
      bounds: [-20, 30, -180, -130]
      resolution: 0.16
      priority: 1
      geographic_selection:
        regions: ["hawaii"]
        bounds: [18.0, 23.0, -162.0, -154.0]
        backup_grid: "global.0p16"
        
    alaska_arctic:
      description: "Alaska & Arctic (9km resolution)"
      grid_name: "arctic.9km"
      bounds: [50, 90, -180, 180]
      resolution: 0.083
      priority: 1
      geographic_selection:
        regions: ["alaska"]
        bounds: [55.0, 72.0, -180.0, -130.0]
        backup_grid: "global.0p16"
        
    global_primary:
      description: "Global mid-latitudes (16km resolution)"
      grid_name: "global.0p16"
      bounds: [-15, 52.5, -180, 180]
      resolution: 0.16
      priority: 2
      geographic_selection:
        regions: ["great_lakes", "global_fallback"]
        bounds: [-90, 90, -180, 180]  # Global coverage
        backup_grid: "global.0p25"
        
    global_fallback:
      description: "Global interpolated (25km resolution)"
      grid_name: "global.0p25"
      bounds: [-90, 90, -180, 180]
      resolution: 0.25
      priority: 3
      geographic_selection:
        regions: ["global"]
        bounds: [-90, 90, -180, 180]
        backup_grid: null  # No backup - this IS the backup

  # Grid selection configuration
  grid_selection:
    method: "geographic_priority"
    fallback_enabled: true
    default_grid: "global.0p25"
  
  # API schedule and timing
  schedule:
    model_runs: [0, 6, 12, 18]  # UTC hours
    forecast_hours: [0, 3, 6, 9, 12, 15, 18, 21, 24, 27, 30, 33, 36, 42, 48, 54, 60, 66, 72]
    data_availability_delay: 180  # minutes after model run
    update_frequency: 21600  # 6 hours in seconds
  
  # Error handling for GFS Wave API
  error_handling:
    max_retries: 3
    timeout_seconds: 30
    backoff_multiplier: 2
    max_backoff_seconds: 300
    retry_on_http_codes: [500, 502, 503, 504, 429]
  
  # Quality control for GFS Wave data
  quality_control:
    max_data_age_hours: 6
    wave_height_max: 30.0  # meters
    wave_period_max: 30.0  # seconds
    wind_speed_max: 100.0  # m/s
  
  # All GFS Wave field mappings
  field_mappings:
    
    # ============================================================================
    # ESSENTIAL WAVE PARAMETERS (HIGH priority - required for surf forecasting)
    # ============================================================================
    wave_height:
      grib_parameter: "swh"                    # FIXED: was "HTSGW"
      database_field: "wave_height"
      database_type: "REAL"
      unit_conversion_required: true          # meters to feet
      forecast_priority: 1
      description: "Significant height of combined wind waves and swell"
      
    wave_period:
      grib_parameter: "perpw"                  # CORRECT: no change needed
      database_field: "wave_period"
      database_type: "REAL"
      unit_conversion_required: false
      forecast_priority: 1
      description: "Primary wave mean period"
      
    wave_direction:
      grib_parameter: "dirpw"                  # CORRECT: no change needed
      database_field: "wave_direction"
      database_type: "REAL"
      unit_conversion_required: false
      forecast_priority: 1
      description: "Primary wave direction"
      
    # ============================================================================
    # ESSENTIAL WIND PARAMETERS (HIGH priority - required for surf quality)
    # ============================================================================
    wind_speed:
      grib_parameter: "ws"                     # FIXED: was "WIND"
      database_field: "wind_speed"
      database_type: "REAL"
      unit_conversion_required: true          # m/s to mph
      forecast_priority: 1
      description: "Wind speed at 10 meters"
      
    wind_direction:
      grib_parameter: "wdir"                   # CORRECT: no change needed
      database_field: "wind_direction"
      database_type: "REAL"
      unit_conversion_required: false
      forecast_priority: 1
      description: "Wind direction at 10 meters"
      
    # ============================================================================
    # WIND COMPONENTS (MEDIUM priority - backup for wind calculations)
    # ============================================================================
    wind_u_component:
      grib_parameter: "u"                      # NEW: added based on GRIB contents
      database_field: "wind_u_component"
      database_type: "REAL"
      unit_conversion_required: true          # m/s to mph
      forecast_priority: 2
      description: "U component of wind at 10 meters"
      
    wind_v_component:
      grib_parameter: "v"                      # NEW: added based on GRIB contents
      database_field: "wind_v_component"
      database_type: "REAL"
      unit_conversion_required: true          # m/s to mph
      forecast_priority: 2
      description: "V component of wind at 10 meters"
      
    # ============================================================================
    # WIND WAVE COMPONENTS (MEDIUM priority - local sea state)
    # ============================================================================
    wind_wave_height:
      grib_parameter: "shww"                   # FIXED: was "WVHGT"
      database_field: "wind_wave_height"
      database_type: "REAL"
      unit_conversion_required: true          # meters to feet
      forecast_priority: 2
      description: "Significant height of wind waves"
      
    wind_wave_period:
      grib_parameter: "mpww"                   # FIXED: was "WVPER"
      database_field: "wind_wave_period"
      database_type: "REAL"
      unit_conversion_required: false
      forecast_priority: 2
      description: "Mean period of wind waves"
      
    wind_wave_direction:
      grib_parameter: "wvdir"                  # CORRECT: no change needed
      database_field: "wind_wave_direction"
      database_type: "REAL"
      unit_conversion_required: false
      forecast_priority: 2
      description: "Direction of wind waves"
      
    # ============================================================================
    # TOTAL SWELL COMPONENTS (HIGH priority - distant storm swell)
    # ============================================================================
    total_swell_height:
      grib_parameter: "shts"                   # NEW: replaces non-existent "SWELL:1"
      database_field: "total_swell_height"
      database_type: "REAL"
      unit_conversion_required: true          # meters to feet
      forecast_priority: 1
      description: "Significant height of total swell"
      
    total_swell_period:
      grib_parameter: "mpts"                   # NEW: replaces non-existent "SWPER:1"
      database_field: "total_swell_period"
      database_type: "REAL"
      unit_conversion_required: false
      forecast_priority: 1
      description: "Mean period of total swell"
      
    total_swell_direction:
      grib_parameter: "swdir"                  # NEW: replaces non-existent "SWDIR:1"
      database_field: "total_swell_direction"
      database_type: "REAL"
      unit_conversion_required: false
      forecast_priority: 1
      description: "Direction of swell waves"

# =============================================================================
# FISH CATEGORIES - User-configurable species targeting
# =============================================================================
fish_categories:
  freshwater_sport:
    display_name: "Freshwater Sport Fish"
    species: ["Bass", "Trout", "Pike", "Walleye"]
    pressure_preference: "falling"
    tide_relevance: false
    
  saltwater_inshore:
    display_name: "Saltwater Inshore"
    species: ["Redfish", "Snook", "Flounder", "Spotted Sea Trout"]
    pressure_preference: "falling"
    tide_relevance: true
    
  saltwater_offshore:
    display_name: "Saltwater Offshore"
    species: ["Mahi", "Tuna", "Marlin", "Wahoo"]
    pressure_preference: "stable"
    tide_relevance: false
    
  bottom_fish:
    display_name: "Bottom Fish"
    species: ["Grouper", "Snapper", "Halibut", "Cod"]
    pressure_preference: "stable_high"
    tide_relevance: true

scoring_criteria:
  # =============================================================================
  # SURF SCORING - Physics-Based Post-Transformation Scoring
  # =============================================================================
  surf_scoring:
    
    # Physics parameters for wave transformation (user-tunable)
    physics_parameters:
      shoaling_factor_max: 1.5         # Maximum shoaling amplification
      refraction_factor_max: 1.2       # Maximum refraction focusing
      breaking_gamma_sand: 0.78        # Breaking index for sand bottoms
      breaking_gamma_reef: 1.0         # Breaking index for reef breaks
      bottom_friction_coefficient: 0.01 # Energy loss coefficient
      
    # Wave height scoring (applied AFTER physics transformation)
    transformed_wave_height_scoring:
      ranges:
        0.0-0.5: 0.1     # Flat
        0.5-1.5: 0.4     # Tiny
        1.5-3.0: 0.8     # Small
        3.0-6.0: 1.0     # Good
        6.0-10.0: 0.9    # Large
        10.0-15.0: 0.6   # Very large
        15.0+: 0.2       # Dangerous
      
    # Wave period scoring (swell quality assessment)
    wave_period_scoring:
      ranges:
        0-6: 0.2         # Poor wind swell
        6-8: 0.4         # Short period
        8-10: 0.6        # Mixed swell
        10-12: 0.8       # Good swell
        12-16: 1.0       # Excellent groundswell
        16-20: 0.9       # Very long period
        20+: 0.8         # Extremely long
        
    # Wind quality (relative to surf spot orientation)
    wind_quality_scoring:
      # Calm conditions (0-3 mph) - based on Scripps research interpolation
      calm: 0.92                    # Slightly below light offshore but above moderate
      
      # Offshore winds (land to ocean) - SCRIPPS RESEARCH-BASED PATTERN
      offshore_light: 1.0           # 3-10 mph - PEAK (Quality Factor 1.2 from Scripps)
      offshore_moderate: 0.83       # 10-20 mph - baseline (Quality Factor 1.0 from Scripps)
      offshore_strong: 0.67         # 20-30 mph - challenging (Quality Factor 0.8 from Scripps)
      offshore_extreme: 0.42        # 30+ mph - difficult (Quality Factor 0.5 from Scripps)
      
      # Onshore winds (ocean to land) - RESEARCH-BASED DECLINING PATTERN
      onshore_light: 0.67           # 0-10 mph - slightly degraded (Quality Factor 0.8 from research)
      onshore_moderate: 0.42        # 10-20 mph - poor conditions (Quality Factor 0.5 from research)
      onshore_strong: 0.17          # 20+ mph - very poor (Quality Factor 0.2 from research)
      
      # Cross-shore winds (parallel to shore) - RESEARCH-BASED DECLINING PATTERN  
      crossshore_light: 0.58        # 0-15 mph - acceptable (Quality Factor 0.7 from research)
      crossshore_strong: 0.25       # 15+ mph - poor conditions (Quality Factor 0.3 from research)
      
    # Wind speed thresholds for quality classification
    wind_speed_thresholds:
      calm_max: 3                   # mph - 0 to 3 mph
      offshore_light_max: 10        # mph - 3 to 10 mph (offshore only)
      offshore_moderate_max: 20     # mph - 10 to 20 mph (offshore only)
      offshore_strong_max: 30       # mph - 20 to 30 mph (offshore only)
      onshore_light_max: 10         # mph - 0 to 10 mph (onshore only)
      onshore_moderate_max: 20      # mph - 10 to 20 mph (onshore only)
      onshore_strong_min: 20.01     # mph - >20 mph (onshore only)
      crossshore_light_max: 15      # mph - 0 to 15 mph (crossshore only)
      crossshore_strong_min: 15.01  # mph - >15 mph (crossshore only)
      
    # Overall rating calculation weights
    scoring_weights:
      wave_height: 0.35         # Transformed wave height importance
      wave_period: 0.35         # Swell quality importance
      wind_quality: 0.20        # Wind condition importance
      tide_phase: 0.10          # Tidal effects importance
      
  # =============================================================================
  # FISHING SCORING - Enhanced Species-Specific Scoring
  # =============================================================================
  fishing_scoring:
    
    # Pressure trend scoring (barometric effects on fish behavior)
    pressure_trend_scoring:
      ranges:
        rising_fast: 0.2          # Fish shut down
        rising_slow: 0.6          # Slow fishing
        stable_high: 1.0          # Excellent conditions
        stable_low: 0.5           # Fair conditions  
        falling_slow: 0.9         # Very good fishing
        falling_fast: 0.7         # Good before front
        
    # Pressure rate thresholds (mb/hour)
    pressure_rate_thresholds:
      fast_change_min: 2.0       # mb/hour for "fast" changes
      slow_change_max: 0.5       # mb/hour for "slow" changes
      stable_range: 0.2          # mb/hour for "stable"
      
    # Tide phase scoring (species-dependent)
    tide_phase_scoring:
      incoming: 0.8             # Rising tide
      high_slack: 0.4           # High tide slack
      outgoing: 1.0             # Falling tide (best)
      low_slack: 0.3            # Low tide slack
      
    # Time of day modifiers
    time_of_day_scoring:
      dawn: 1.0                 # Early morning feeding
      morning: 0.7              # Mid morning
      midday: 0.4               # Noon (typically slower)
      afternoon: 0.6            # Afternoon pickup
      dusk: 1.0                 # Evening feeding
      night: 0.8                # Night fishing
      
    # Species activity modifiers (by category)
    species_activity_modifiers:
      saltwater_inshore: 1.0    # Base multiplier
      saltwater_offshore: 0.8   # Less tide dependent
      freshwater_sport: 0.6     # Less pressure dependent
      bottom_fish: 1.2          # More responsive to conditions
      
    # Overall fishing rating weights
    scoring_weights:
      pressure_trend: 0.4       # Barometric pressure importance
      tide_phase: 0.3           # Tidal effects importance
      time_of_day: 0.2          # Time effects importance
      species_activity: 0.1     # Species-specific modifiers

    rating_descriptions:
      1: "Slow fishing conditions"
      2: "Fair fishing conditions" 
      3: "Good fishing conditions"
      4: "Excellent fishing conditions"
      5: "Epic fishing conditions"

    description_factor_thresholds:
      pressure_threshold: 0.7    # Score threshold to mention pressure in description
      tide_threshold: 0.7        # Score threshold to mention tide in description  
      time_threshold: 0.7        # Score threshold to mention time in description


# =============================================================================
# BATHYMETRY DATA SOURCE - GEBCO API via OpenTopo
# =============================================================================
bathymetry_data:
  description: "GEBCO Global Bathymetry - Multi-Point Path Analysis"
  data_source: "gebco_api"
  implementation_scope: "install_time_only"
  
  # API configuration for OpenTopo Data API
  api_configuration:
    base_url: "https://api.opentopodata.org/v1/gebco2020"
    timeout_seconds: 30
    retry_attempts: 3
    retry_delay_seconds: 2
    max_locations_per_request: 100
    rate_limit_delay: 1.1
    interpolation: "bilinear"       # FIXED: Moved here from path_analysis
    
  # Attribution requirements
  attribution:
    dataset: "GEBCO Compilation Group (2025) GEBCO 2025 Grid"
    source: "Bathymetry data via OpenTopo Data API"
    disclaimer: "Not for navigation or safety at sea"
    
  # Surf break validation settings
  surf_break_validation:
    optimal_depth_range:
      min_meters: 1.5              # Minimum depth for safe surfing
      max_meters: 6.0              # Maximum for typical surf breaks
    depth_adjustment:
      shallow_limit: 1.5           # Always adjust if shallower
      deep_warning: 6.0            # User choice if deeper
      max_adjustment_meters: 250   # Conservative 0.25km limit
      adjustment_step_meters: 50   # Distance per adjustment attempt
      max_api_calls: 10            # Budget for adjustment attempts
    
  # Land/sea validation
  coordinate_validation:
    enable_land_sea_validation: true
    land_elevation_threshold: 0.0
    validate_fishing_spots: true
    validate_surf_spots: true
    auto_adjust_coordinates: false

  # NEW ADDITION: Adaptive spacing algorithm configuration
  adaptive_spacing:
    enable_adaptive_algorithm: true
    description: "Gradient-based adaptive refinement of bathymetric sampling points"
    
    # Core algorithm parameters
    refinement_gradient_threshold: 0.02      # 1:50 slope ratio triggers refinement
    coarsening_gradient_threshold: 0.002     # 1:500 slope ratio allows coarsening
    max_total_points: 150                     # Maximum points for single surf path
    min_total_points: 16                     # Minimum points to maintain coverage
    max_refinement_iterations: 4             # Prevent infinite refinement loops
    
    # Depth-based zone classification
    critical_depth_min: 5.0                  # Critical zone lower bound (meters)
    critical_depth_max: 50.0                 # Critical zone upper bound (meters)  
    deep_water_threshold: 50.0               # Deep water classification threshold
    
    # Algorithm safety and validation
    validation_enabled: true                 # Enforce scientific validation
    cliff_face_gradient_limit: 0.5           # 50% grade = cliff face detection
    cliff_face_distance_limit: 500           # Distance threshold for cliff detection
    max_reasonable_gradient: 2.0             # Maximum allowed gradient (100% grade)
    
    # Statistical anomaly detection (IQR method)
    anomaly_detection_enabled: true          # Enable IQR-based outlier detection
    iqr_multiplier: 1.5                     # Standard IQR outlier threshold
    min_points_for_statistics: 4            # Minimum points needed for IQR analysis
    
    # Performance and API efficiency  
    batch_api_calls: true                   # Use batch GEBCO API requests
    rate_limit_compliance: true             # Respect 1 call/second limit
    api_timeout_seconds: 30                 # Timeout for GEBCO API calls
    
  # NEW: Zone-based maximum segment distances (data-driven)
  zone_refinement_limits:
    deep_water_max_segment_m: 1000         # Deep water (>50m): 1km segments OK
    transition_max_segment_m: 500          # Transition zone (20-50m): 500m max
    critical_max_segment_m: 200            # Critical zone (5-20m): 200m max
    breaking_max_segment_m: 100            # Breaking zone (<5m): 100m max
    
  # PRESERVE: All existing path_analysis configuration
  path_analysis:
    path_resolution_points: 15              # Used when adaptive algorithm disabled
    offshore_distance_meters: 20000         # Standard offshore distance
    interpolation: "bilinear"               # GEBCO interpolation method
    
    # Fallback parameters for non-adaptive mode
    default_wave_period: 12.0               # Default wave period for zone calculations
    enable_validation: true                 # Enable bathymetric profile validation